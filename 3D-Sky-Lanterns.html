<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å¤©ç‡ˆ + å¤šé å¡ç‰‡(ä¸Šä¸€é /ä¸‹ä¸€é ) + æœ€çµ‚é ç„¡ä¸‹ä¸€é  + éŸ³æ¨‚ + éŸ¿æ‡‰å¼</title>
  <!-- Three.js & GSAP -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

  <style>
    /* === å…¨å±€æ¨£å¼ï¼šæ¼¸å±¤èƒŒæ™¯ + å½ˆæ€§å­—é«” === */
    html, body {
      margin: 0; 
      padding: 0; 
      height: 100%;
      font-family: "Microsoft JhengHei", sans-serif;
      font-size: clamp(14px, 2vw, 20px);
      background: linear-gradient(160deg, #FCE3D4, #FFEFEA);
      overflow: hidden;
    }

    /* 3D å ´æ™¯å®¹å™¨ */
    #threeContainer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
    }
    canvas { display: block; width: 100%; height: 100%; }

    /* å¤©ç‡ˆè¼¸å…¥å€ */
    #inputContainer {
      position: absolute;
      bottom: 2%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      width: clamp(200px, 30vw, 400px);
    }
    #textInput {
      width: 100%;
      height: clamp(4rem, 12vh, 8rem);
      padding: 0.5rem;
      font-size: 1rem;
      border: 2px solid #ffa500;
      border-radius: 0.3rem;
      resize: none;
      outline: none;
      line-height: 1.5;
    }
    #buttonContainer { display: flex; gap: 0.5rem; }
    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      transition: background-color 0.3s;
      white-space: nowrap;
    }
    #updateButton {
      background-color: #ffa500;
      color: #fff;
    }
    #updateButton:hover {
      background-color: #ff8c00;
    }
    #releaseButton {
      background-color: #ff4444;
      color: #fff;
    }
    #releaseButton:hover {
      background-color: #cc0000;
    }

    /* é£„å®Œå¾Œé¡¯ç¤ºçš„ã€Œä¸‹ä¸€é ã€æŒ‰éˆ• */
    #nextPageButton {
      position: absolute;
      bottom: 40%;
      left: 50%;
      transform: translateX(-50%);
      padding: 1rem 2rem;
      font-size: clamp(1rem, 2vw, 1.5rem);
      background: #ffa500;
      color: #fff;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      display: none;
      z-index: 9999;
      box-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.2);
    }
    #nextPageButton:hover {
      background-color: #ff8c00;
    }

    /* å¤šé å¡ç‰‡å®¹å™¨ (æ·ºæ©˜èƒŒæ™¯) */
    #cardsContainer {
      position: absolute;
      top: 0; left: 0;
      width: 100%; 
      height: 100%;
      display: none; /* åˆå§‹éš±è— */
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
      padding: 1rem;
      background: linear-gradient(160deg, #FFE7D8, #FFD9BB);
    }
    .page {
      width: clamp(280px, 60vw, 500px);
      min-height: clamp(300px, 50vh, 600px);
      border-radius: 1rem;
      box-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.2);
      margin-bottom: 1rem;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: linear-gradient(135deg, #FFE1C4, #FFD3B0);
    }
    .pageTitle {
      font-size: clamp(1rem, 2.5vw, 1.5rem);
      font-weight: bold;
      color: #fff;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      margin-bottom: 0.5rem;
    }
    .pageContent {
      font-size: clamp(0.8rem, 2vw, 1.2rem);
      line-height: 1.6;
      color: #333;
      background: rgba(255,255,255,0.6);
      padding: 0.8rem;
      border-radius: 0.5rem;
      box-shadow: inset 0 0.1rem 0.3rem rgba(0,0,0,0.15);
      white-space: pre-wrap;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* å¡ç‰‡çš„ã€Œä¸Šä¸€é ã€ã€Œä¸‹ä¸€é ã€æŒ‰éˆ• */
    #cardButtons {
      display: flex;
      gap: 1rem;
    }
    .cardNavBtn {
      padding: 0.5rem 1rem;
      font-size: clamp(1rem, 2vw, 1.2rem);
      background: #ffa500;
      color: #fff;
      border: none;
      border-radius: 0.3rem;
      cursor: pointer;
      box-shadow: 0 0.2rem 0.5rem rgba(0,0,0,0.2);
    }
    .cardNavBtn:hover {
      background-color: #ff8c00;
    }
    .cardNavBtn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* éŸ³æ¨‚ä¸é¡¯ç¤º */
    #bgm { display: none; }
  </style>
</head>

<body>
  <!-- 3D å¤©ç‡ˆå®¹å™¨ -->
  <div id="threeContainer"></div>

  <!-- è¼¸å…¥UI -->
  <div id="inputContainer">
    <textarea id="textInput" placeholder="è¼¸å…¥ä½ çš„é¡˜æœ› (æ¯è¡Œä¸€å€‹)..."></textarea>
    <div id="buttonContainer">
      <button id="updateButton">æ›´æ–°æ–‡å­—</button>
      <button id="releaseButton" disabled>é‡‹æ”¾</button>
    </div>
  </div>

  <!-- é£„åˆ°ä¸­é€” -> é¡¯ç¤º "ä¸‹ä¸€é " -->
  <button id="nextPageButton">ä¸‹ä¸€é </button>

  <!-- å¤šé å¡ç‰‡ -->
    <div id="cardsContainer">
      <div class="page" id="page0">
        <div class="pageContent">
          ä¸çŸ¥ä¸è¦ºæˆ‘å€‘æ”œæ‰‹èµ°éä¸€å€‹æœˆï¼Œ<br>
          ç”Ÿå‘½ä¸­æœ€å¹¸ç¦çš„æ™‚å…‰ï¼Œ<br>
          éƒ½æ˜¯è·Ÿå¯¶å¯¶åœ¨ä¸€èµ·çš„é»é»æ»´æ»´ã€‚
        </div>
      </div>
    
      <div class="page" id="page1">
        <div class="pageContent">
          æˆ‘å¾ˆå¸¸çœ‹è‘—æˆ‘å€‘å‡ºå»ç©çš„ç…§ç‰‡<br>
          é‚£äº›ç•«é¢å°±åƒç³–æœä¸€æ¨£ï¼Œ<br>
          è®“æˆ‘çš„å¿ƒè£¡ç”œç”œçš„ã€‚
        </div>
      </div>
    
      <div class="page" id="page2">
        <div class="pageContent">
          æ‰‹ç‰½è‘—æ‰‹å¥”è·‘åœ¨æ²™ç˜ä¸Šï¼Œ<br>
          å¦³çš„ç¬‘å®¹æ¯”é™½å…‰é‚„è¦è€€çœ¼
        </div>
      </div>
    
      <div class="page" id="page3">
        <div class="pageContent">
          æ²™ç˜ä¸Šçš„è…³å°ä¹Ÿè¨±è¢«æµ·æµªå¸¶èµ°ï¼Œ<br>
          æ‰‹å°æ¿ä¸Šçš„æ²™å­ä¹Ÿè¨±éš¨æ™‚é–“è„«è½ï¼Œ<br>
          ä½†åœ¨æˆ‘å¿ƒè£¡ï¼Œ<br>
          é‚£æº«æš–å»æ˜¯æ°¸æ†ã€‚
        </div>
      </div>
    
      <div class="page" id="page4">
        <div class="pageContent">
          æˆ‘å€‘æ¯”å‡ºæ„›å¿ƒçš„ç¬é–“ï¼Œ<br>
          å·²æˆç‚ºè…¦æµ·æœ€çè²´çš„è¨˜æ†¶ï¼Œ<br>
          æ¯ç•¶æƒ³èµ·ï¼Œç¸½æœƒä¸è‡ªè¦ºå¾®ç¬‘ã€‚
        </div>
      </div>
    
      <div class="page" id="page5">
        <div class="pageContent">
          ç„¡è«–é¢å°å¤šå°‘æŒ‘æˆ°ï¼Œ<br>
          æˆ‘éƒ½æœƒç·Šæ¡å¦³çš„æ‰‹ï¼Œ<br>
          é™ªå¦³ä¸€èµ·èµ°éé¢¨é›¨ã€‚
        </div>
      </div>
    
      <div class="page" id="page6">
        <div class="pageContent">
          å¦³æ˜¯æˆ‘äººç”Ÿä¸­æœ€ç¾çš„å¥‡è¹Ÿï¼Œ<br>
          æˆ‘é¡˜ç”¨ä¸€è¼©å­çš„æ™‚é–“ï¼Œ<br>
          çæƒœå¦³å¸¶ä¾†çš„æ¯ä¸€æ¬¡å¹¸ç¦ï¼Œ<br>
          å¯¶å¯¶ æˆ‘æ„›å¦³!!æ°¸é æ„›å¦³!
        </div>
      </div>
    
      <div class="page" id="page7">
        <div class="pageContent">
          â„ï¸ã€Šå¯’èˆ‡è±”é™½ã€‹ğŸŒ<br>
          æ¸…æ™¨è–„éœ§è£¡ï¼Œæ¢…èŠ±åˆç¶»ï¼Œ<br>
          ä¸€ç¸·æ¸…å¯’æ²å…¥å¿ƒé–“ã€‚
        </div>
      </div>
    
      <div class="page" id="page8">
        <div class="pageContent">
          æ±æ–¹è±”é™½å‡èµ·ï¼Œ<br>
          æº«æŸ”çš„å…‰ç·šæ‹‚éå±±å·’ï¼Œ<br>
          èåŒ–æé ­ä¸Šçš„å†°éœœã€‚
        </div>
      </div>
    
      <div class="page" id="page9">
        <div class="pageContent">
          æœˆä¸‹æ¹–æ°´è¼•è¼•è•©æ¼¾ï¼Œ<br>
          æ˜Ÿè¾°èˆ‡å¾®é¢¨å‘¢å–ƒç´°èªï¼Œ<br>
          æ¼£æ¼ªè¿°èªªè‘—ç´°ç´°çš„æƒ…è©±ã€‚
        </div>
      </div>
    
      <div class="page" id="page10">
        <div class="pageContent">
          å¯’èˆ‡è±”é™½ï¼Œå‘½ä¸­è¨»å®šç›¸é‡ï¼Œ<br>
          åŒ—é¢¨èˆ‡æš–é™½ç›¸æ“ï¼Œ<br>
          å†°å†·æ‚„ç„¶æ¶ˆæ•£ã€‚
        </div>
      </div>
    
      <div class="page" id="page11">
        <div class="pageContent">
          ç„¡è«–å‰è·¯å¦‚ä½•å´å¶‡ï¼Œ<br>
          å¯’èˆ‡è±”é™½æ°¸é ç›¸ä¼´ï¼Œ<br>
          åœ¨å¤©åœ°é–“ï¼Œæ„›æƒ…æ°¸ä¸å‡‹é›¶ã€‚
        </div>
      </div>

    <div id="cardButtons">
      <button class="cardNavBtn" id="cardPrevBtn" disabled>ä¸Šä¸€é </button>
      <button class="cardNavBtn" id="cardNextBtn">ä¸‹ä¸€é </button>
    </div>
  </div>

  <!-- éŸ³æ¨‚ -->
  <audio id="bgm" src="music.mp3"></audio>
  <!-- TODO: æ”¹ç‚ºä½ è‡ªå·±çš„éŸ³æª”è·¯å¾‘ -->

  <script>
    let scene, camera, renderer;
    let cylinderMesh, insideMesh;
    let textTexture, textCtx;
    let isReleased=false;

    // ä¸‰é , ç¬¬ä¸‰é ( index=2 ) ä¸é¡¯ç¤º "ä¸‹ä¸€é "
    let currentPage=0;
    const totalPages=12;

    // å‡è¨­å¾Œç«¯API:
    const BACKEND_API="https://sky-lanterns.onrender.com/save-wish";

    initScene();
    animate();
    setupUI();

    function initScene(){
      const container=document.getElementById('threeContainer');
      scene=new THREE.Scene();
      camera=new THREE.PerspectiveCamera(
        75,
        container.clientWidth/container.clientHeight,
        0.1,1000
      );
      renderer=new THREE.WebGLRenderer({antialias:true});
      renderer.shadowMap.enabled=true;
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      // ä¸»å…‰
      const mainLight=new THREE.PointLight(0xffffff,1,50);
      mainLight.position.set(0,10,5);
      mainLight.castShadow=true;
      scene.add(mainLight);

      // åº•éƒ¨æ©˜å…‰ => è®“å¤©ç‡ˆåº•éƒ¨æ›´äº®
      const bottomLight=new THREE.PointLight(0xffa500,2,15);
      bottomLight.position.set(0,-15,0);
      scene.add(bottomLight);

      // ç’°å¢ƒå…‰
      const ambient=new THREE.AmbientLight(0x404040);
      scene.add(ambient);

      camera.position.z=22;

      createLantern();
      window.addEventListener('resize', onWindowResize, false);
    }

    function createLantern(){
      // å¤–éƒ¨ Cylinder: top=3.7, bottom=3.0, height=7, 32æ®µ, å°é ‚
      const outsideGeom=new THREE.CylinderGeometry(3.7,3.0,7,32,1,false);

      // å¤©ç‡ˆè²¼åœ–(æ©˜è‰²æ¼¸å±¤ + "ç¥ˆç¦")
      const lanternCanvas=document.createElement('canvas');
      lanternCanvas.width=512; 
      lanternCanvas.height=512;
      const ctx=lanternCanvas.getContext('2d');

      // æ¼¸å±¤
      const grad=ctx.createLinearGradient(0,0,0,512);
      grad.addColorStop(0,"#ffb05e");
      grad.addColorStop(1,"#ff7030");
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,512,512);

      // ä¸­å¿ƒäº®å€
      ctx.fillStyle="rgba(255,255,255,0.15)";
      ctx.beginPath();
      ctx.ellipse(256,250,110,160,0,0,Math.PI*2);
      ctx.fill();

      // ä¸Šå£ / ä¸‹å£
      ctx.strokeStyle="rgba(0,0,0,0.3)";
      ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(180,90); ctx.lineTo(332,90); ctx.stroke();
      ctx.beginPath(); ctx.ellipse(256,420,80,25,0,0,Math.PI*2); ctx.stroke();

      // "ç¥ˆç¦"
      ctx.save();
      ctx.fillStyle="#fff";
      ctx.font="48px KaiTi";
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.translate(256,140);
      ctx.fillText("ç¥ˆç¦", 0,0);
      ctx.restore();

      const outsideTex=new THREE.CanvasTexture(lanternCanvas);
      const outsideMat=new THREE.MeshStandardMaterial({ map:outsideTex });
      cylinderMesh=new THREE.Mesh(outsideGeom, outsideMat);
      cylinderMesh.castShadow=true;

      // y= -11.5 => bottom= -18.5 => å¾é é¢åº•éƒ¨é–‹å§‹
      cylinderMesh.position.y=-11.5;
      scene.add(cylinderMesh);

      // å…§éƒ¨ Cylinder => emissive
      const insideGeom=new THREE.CylinderGeometry(3.65,3.0,7,32,1,false);
      const glowMat=new THREE.MeshStandardMaterial({
        color:0x000000,
        emissive:0xffa500,
        emissiveIntensity:1.0,
        side:THREE.BackSide
      });
      insideMesh=new THREE.Mesh(insideGeom, glowMat);
      insideMesh.position.y=-11.5;
      scene.add(insideMesh);

      // é¡˜æœ›æ–‡å­— => è²¼åœ¨å¤©ç‡ˆ (å­ç‰©ä»¶)
      const textCanvas=document.createElement('canvas');
      textCanvas.width=1024; textCanvas.height=1024;
      textCtx=textCanvas.getContext('2d');
      textTexture=new THREE.CanvasTexture(textCanvas);

      const textMat=new THREE.MeshBasicMaterial({ map:textTexture, transparent:true });
      const textPlane=new THREE.PlaneGeometry(3,6);
      const textMesh=new THREE.Mesh(textPlane, textMat);
      textMesh.position.set(0,0,3.8);
      cylinderMesh.add(textMesh);
    }

    function animate(){
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }

    function onWindowResize(){
      const c=document.getElementById('threeContainer');
      camera.aspect=c.clientWidth/c.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(c.clientWidth, c.clientHeight);
    }

    // ===== å¾Œç«¯å„²å­˜ =====
    async function saveWishToBackend(wish){
      try{
        const res=await fetch(BACKEND_API,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({wish})
        });
        if(!res.ok){
          console.error("å„²å­˜å¤±æ•—:", await res.text());
        } else {
          console.log("é¡˜æœ›å·²æˆåŠŸå„²å­˜ï¼");
        }
      }catch(e){
        console.error("APIéŒ¯èª¤:", e);
      }
    }

    // ===== æ›´æ–°é¡˜æœ›æ–‡å­— =====
    async function updateText(){
      const val=document.getElementById('textInput').value.trim();
      if(!val)return;
      await saveWishToBackend(val);

      textCtx.clearRect(0,0,1024,1024);
      textCtx.fillStyle='black';
      textCtx.font='110px KaiTi';
      textCtx.textAlign='center';
      textCtx.textBaseline='middle';

      let lines=val.split('\n');
      let maxCharsPerColumn=5;
      let startX=512, startY=150;
      let columnIndex=0;

      lines.forEach(line=>{
        let words=line.split('');
        for(let i=0; i<words.length; i++){
          if(i%maxCharsPerColumn===0 && i!==0){
            columnIndex++;
          }
          textCtx.fillText(
            words[i],
            startX - columnIndex*120,
            startY + (i%maxCharsPerColumn)*140
          );
        }
        columnIndex++;
      });

      textTexture.needsUpdate=true;
      document.getElementById('releaseButton').disabled=false;
    }

    // ===== é‡‹æ”¾å¤©ç‡ˆ => å¾€ä¸Šé£„ => é¡¯ç¤º "ä¸‹ä¸€é " => ç¹¼çºŒé£›å‡ºé é¢ =====
    function releaseLantern(){
      if(isReleased)return;
      isReleased=true;

      // åˆ†å…©æ®µ:
      // 1) y=-11.5 -> y=8.5 (8s)
      gsap.to([cylinderMesh.position, insideMesh.position], {
        y:8.5,
        duration:8,
        ease:'linear',
        onComplete: ()=>{
          // é¡¯ç¤º"ä¸‹ä¸€é "
          document.getElementById('nextPageButton').style.display='block';
          // 2) ç¹¼çºŒå¾€ä¸Š y=40 (12s)
          gsap.to([cylinderMesh.position, insideMesh.position], {
            y:40,
            duration:12,
            ease:'linear'
          });
        }
      });

      // æ·¡å‡ºè¼¸å…¥UI
      const c=document.getElementById('inputContainer');
      c.style.opacity='0';
      setTimeout(()=>{ c.style.display='none'; },500);
    }

    // ===== é£›åˆ°ä¸­æ®µ -> "ä¸‹ä¸€é " => é¡¯ç¤ºå¤šé å¡ç‰‡ =====
    function gotoCardsPage(){
      // éš±è—3D
      document.getElementById('threeContainer').style.display='none';
      document.getElementById('nextPageButton').style.display='none';

      // é¡¯ç¤ºå¤šé å¡ç‰‡
      document.getElementById('cardsContainer').style.display='flex';
      currentPage=0;
      showCardPage(0);

      // æ’¥æ”¾éŸ³æ¨‚
      const bgm=document.getElementById('bgm');
      bgm.play().catch(e=>console.log("éŸ³æ¨‚è¢«é˜»æ“‹:", e));
    }

    // é¡¯ç¤ºç‰¹å®šé 
    function showCardPage(idx){
      for(let i=0;i<totalPages;i++){
        document.getElementById('page'+i).style.display='none';
      }
      document.getElementById('page'+idx).style.display='flex';

      // ä¸Šä¸€é /ä¸‹ä¸€é  æŒ‰éˆ• disable / hide
      document.getElementById('cardPrevBtn').disabled = (idx<=0);

      // æœ€å¾Œä¸€é  => ä¸é¡¯ç¤º "ä¸‹ä¸€é " => ç›´æ¥ hide
      const nextBtn=document.getElementById('cardNextBtn');
      if(idx>=totalPages-1){
        nextBtn.style.display='none';
      } else {
        nextBtn.style.display='inline-block';
        nextBtn.disabled=false;
      }
    }

    function prevCardPage(){
      if(currentPage>0){
        currentPage--;
        showCardPage(currentPage);
      }
    }
    function nextCardPage(){
      if(currentPage<totalPages-1){
        currentPage++;
        showCardPage(currentPage);
      }
    }

    function setupUI(){
      document.getElementById('updateButton').addEventListener('click', updateText);
      document.getElementById('releaseButton').addEventListener('click', releaseLantern);
      document.getElementById('nextPageButton').addEventListener('click', gotoCardsPage);
      
      document.getElementById('cardPrevBtn').addEventListener('click', prevCardPage);
      document.getElementById('cardNextBtn').addEventListener('click', nextCardPage);
    }
  </script>
</body>
</html>
