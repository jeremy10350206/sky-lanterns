<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 天燈網站</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: Arial, sans-serif; }
        canvas { display: block; }
        #inputContainer {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: opacity 0.5s ease;
        }
        #textInput {
            width: 250px;
            height: 80px;
            padding: 8px;
            font-size: 14px;
            border: 2px solid #ffa500;
            border-radius: 5px;
            resize: none;
            outline: none;
        }
        #buttonContainer {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }
        button {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        #updateButton {
            background-color: #ffa500;
            color: white;
        }
        #updateButton:hover {
            background-color: #ff8c00;
        }
        #releaseButton {
            background-color: #ff4444;
            color: white;
        }
        #releaseButton:hover {
            background-color: #cc0000;
        }
    </style>
</head>
<body>
    <div id="inputContainer">
        <textarea id="textInput" placeholder="輸入你的願望 (每行一個)..."></textarea>
        <div id="buttonContainer">
            <button id="updateButton" onclick="updateText()">更新文字</button>
            <button id="releaseButton" onclick="releaseLantern()" disabled>釋放</button>
        </div>
    </div>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.shadowMap.enabled = true;
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.PointLight(0xffffff, 2, 100);
        light.position.set(0, 10, 5);
        light.castShadow = true;
        scene.add(light);

        const ambientLight = new THREE.AmbientLight(0x808080);
        scene.add(ambientLight);

        const geometry = new THREE.CylinderGeometry(3.5, 3.5, 7, 32);
        const material = new THREE.MeshStandardMaterial({ color: 0xffa500 });
        const lantern = new THREE.Mesh(geometry, material);
        lantern.position.set(0, -2, 0);
        lantern.castShadow = true;
        scene.add(lantern);

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1024;
        canvas.height = 1024;
        const texture = new THREE.CanvasTexture(canvas);
        const textMaterial = new THREE.MeshBasicMaterial({ map: texture, transparent: true });
        const textPlane = new THREE.PlaneGeometry(3, 6);
        const textMesh = new THREE.Mesh(textPlane, textMaterial);
        textMesh.position.set(0, 0, 3.55);
        lantern.add(textMesh);

        let isReleased = false;

        async function saveWishToBackend(wishText) {
            try {
                const response = await fetch('https://your-backend-api.com/api/wishes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ wish: wishText })
                });

                if (response.ok) {
                    console.log("願望已成功儲存！");
                } else {
                    console.error("儲存失敗！");
                }
            } catch (error) {
                console.error("請求錯誤:", error);
            }
        }

        function updateText() {
            const inputText = document.getElementById('textInput').value.trim();
            if (!inputText) return;

            saveWishToBackend(inputText);

            const lines = inputText.split('\n');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'black';
            ctx.font = '110px KaiTi';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            let maxCharsPerColumn = 5;
            let startX = canvas.width / 2;
            let startY = 150;
            let columnIndex = 0;

            lines.forEach((line) => {
                let words = line.split('');
                for (let i = 0; i < words.length; i++) {
                    if (i % maxCharsPerColumn === 0 && i !== 0) {
                        columnIndex++;
                    }
                    ctx.fillText(words[i], startX - columnIndex * 120, startY + (i % maxCharsPerColumn) * 140);
                }
                columnIndex++;
            });
            texture.needsUpdate = true;
            document.getElementById('releaseButton').disabled = false;
        }

        function releaseLantern() {
            if (!isReleased) {
                gsap.to(lantern.position, { y: "+=20", duration: 20, ease: "linear" });
                document.getElementById('inputContainer').style.opacity = '0';
                setTimeout(() => { document.getElementById('inputContainer').style.display = 'none'; }, 500);
                isReleased = true;
            }
        }

        camera.position.z = 22;
        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
